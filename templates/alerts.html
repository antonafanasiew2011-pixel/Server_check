{% extends "base.html" %}
{% block title %}–ê–ª–µ—Ä—Ç—ã ‚Ä¢ Server Check{% endblock %}
{% block content %}
  <div class="page-header">
    <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–ª–µ—Ä—Ç–∞–º–∏</h1>
    <div class="page-actions">
      <a href="/alert-groups" class="btn btn-secondary">üìÅ –ì—Ä—É–ø–ø—ã –∞–ª–µ—Ä—Ç–æ–≤</a>
      <a href="/reports/export.pdf?report_type=alerts" class="btn btn-secondary">üìÑ –≠–∫—Å–ø–æ—Ä—Ç PDF</a>
      <button class="btn btn-secondary" onclick="testTelegram()">ü§ñ –¢–µ—Å—Ç Telegram</button>
      <button class="btn btn-secondary" onclick="location.reload()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-left: 8px;">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ –∞–ª–µ—Ä—Ç–∞</h3>
    <form method="post" action="/alerts">
      <div class="form-row" style="margin-right: 10px; margin-left: 10px">
        <div class="form-group">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞</label>
          <input name="name" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ" required />
        </div>
        <div class="form-group">
          <label class="form-label">–°–µ—Ä–≤–µ—Ä</label>
          <select name="server_id" class="form-control" required>
            {% for s in servers %}
            <option value="{{ s.id }}">{{ s.hostname }} ({{ s.ip_address }})</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">–ì—Ä—É–ø–ø–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
          <select name="group_id" class="form-control">
            <option value="">–ë–µ–∑ –≥—Ä—É–ø–ø—ã</option>
            {% for group in groups %}
            <option value="{{ group.id }}">{{ group.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">–ú–µ—Ç—Ä–∏–∫–∞</label>
          <select name="metric" class="form-control" required>
            <option value="cpu">CPU %</option>
            <option value="cpu_temp">CPU Temperature ¬∞C</option>
            <option value="ram">RAM %</option>
            <option value="swap">Swap %</option>
            <option value="disk">Disk %</option>
            <option value="disk_io">Disk I/O MB/s</option>
            <option value="processes">Processes</option>
            <option value="net_in">Net In Kbps</option>
            <option value="net_out">Net Out Kbps</option>
            <option value="reachable">Reachable (1/0)</option>
          </select>
        <div class="form-group">
          <label class="form-label">–û–ø–µ—Ä–∞—Ç–æ—Ä</label>
          <select name="operator" class="form-control" required>
            <option value=">">&gt; (–±–æ–ª—å—à–µ)</option>
            <option value="<">&lt; (–º–µ–Ω—å—à–µ)</option>
            <option value="=">= (—Ä–∞–≤–Ω–æ)</option>
            <option value="!=">!= (–Ω–µ —Ä–∞–≤–Ω–æ)</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">–ü–æ—Ä–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</label>
          <input name="threshold" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ" required />
        </div>
        <div class="form-group">
          <label class="form-label">–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å</label>
          <select name="severity" class="form-control" required>
            <option value="info">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</option>
            <option value="warning" selected>‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</option>
            <option value="critical">üö® –ö—Ä–∏—Ç–∏—á–Ω–æ</option>
          </select>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ</button>
    </form>
  </div>

  <div class="table-container">
    <h3 style="margin-left: 8px;">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∞–ª–µ—Ä—Ç–æ–≤</h3>
    <table class="servers-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
          <th>–°–µ—Ä–≤–µ—Ä</th>
          <th>–ì—Ä—É–ø–ø–∞</th>
          <th>–£—Å–ª–æ–≤–∏–µ</th>
          <th>–°–µ—Ä—å–µ–∑–Ω–æ—Å—Ç—å</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rules %}
        <tr>
          <td>{{ r.id }}</td>
          <td><strong>{{ r.name }}</strong></td>
          <td>{{ r.server_id }}</td>
          <td>
            {% if r.group %}
              <span class="group-badge">{{ r.group.name }}</span>
            {% else %}
              ‚Äî
            {% endif %}
          </td>
          <td>
            <code>{{ r.metric }} {{ r.operator }} {{ r.threshold }}</code>
          </td>
          <td>
            {% if r.severity == 'critical' %}
              <span class="severity-badge severity-critical">üö® –ö—Ä–∏—Ç–∏—á–Ω–æ</span>
            {% elif r.severity == 'warning' %}
              <span class="severity-badge severity-warning">‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</span>
            {% else %}
              <span class="severity-badge severity-info">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
            {% endif %}
          </td>
          <td>
            <span class="status-badge {{ 'status-online' if r.enabled else 'status-offline' }}">
              {{ '–í–∫–ª—é—á–µ–Ω' if r.enabled else '–û—Ç–∫–ª—é—á–µ–Ω' }}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <form method="post" action="/alerts/{{ r.id }}/toggle" style="display:inline;">
                <button type="submit" class="btn btn-sm {{ 'btn-warning' if r.enabled else 'btn-success' }}">
                  {{ '–û—Ç–∫–ª—é—á–∏—Ç—å' if r.enabled else '–í–∫–ª—é—á–∏—Ç—å' }}
                </button>
              </form>
              <form method="post" action="/alerts/{{ r.id }}/delete" style="display:inline;">
                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ {{ r.name }}?')">–£–¥–∞–ª–∏—Ç—å</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="table-container">
    <h3 style="margin-left: 8px;">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –∞–ª–µ—Ä—Ç–æ–≤</h3>
    <table class="servers-table">
      <thead>
        <tr>
          <th>–í—Ä–µ–º—è</th>
          <th>–ü—Ä–∞–≤–∏–ª–æ</th>
          <th>–°–µ—Ä–≤–µ—Ä</th>
          <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
          <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
        </tr>
      </thead>
      <tbody>
        {% for e in events %}
        <tr>
          <td>
            <span class="timestamp">{{ format_moscow_time(e.timestamp) }}</span>
          </td>
          <td>{{ e.rule_id }}</td>
          <td>{{ e.server_id }}</td>
          <td>
            <span class="metric-badge metric-critical">{{ e.value }}</span>
          </td>
          <td>
            <span class="details">{{ e.message }}</span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    async function testTelegram() {
      try {
        const response = await fetch('/test/telegram', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
          showNotification('‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram!', 'success');
        } else {
          showNotification('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + result.message, 'error');
        }
      } catch (error) {
        showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
      }
    }
  </script>
{% endblock %}


