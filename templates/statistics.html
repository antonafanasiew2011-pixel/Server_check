{% extends "base.html" %}
{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ‚Ä¢ Server Check{% endblock %}
{% block head %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}
{% block content %}
  <div class="page-header">
    <h1>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h1>
    <div class="page-actions">
      <button class="btn btn-secondary" onclick="refreshStats()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
  </div>

  <div class="stats-grid">
    <!-- System Overview -->
    <div class="stat-card">
      <h3>–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã</h3>
      <div class="stat-metrics">
        <div class="metric-row">
          <span class="metric-label">–í—Å–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–æ–≤:</span>
          <span class="metric-value" id="total-servers">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">–û–Ω–ª–∞–π–Ω:</span>
          <span class="metric-value status-online" id="online-servers">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">–û—Ñ—Ñ–ª–∞–π–Ω:</span>
          <span class="metric-value status-offline" id="offline-servers">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">–ö–ª–∞—Å—Ç–µ—Ä—ã:</span>
          <span class="metric-value" id="cluster-servers">-</span>
        </div>
      </div>
    </div>

    <!-- Performance Metrics -->
    <div class="stat-card">
      <h3>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</h3>
      <div class="stat-metrics">
        <div class="metric-row">
          <span class="metric-label">–°—Ä–µ–¥–Ω—è—è CPU:</span>
          <span class="metric-value" id="avg-cpu">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">–°—Ä–µ–¥–Ω—è—è RAM:</span>
          <span class="metric-value" id="avg-ram">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">–°—Ä–µ–¥–Ω—è—è Disk:</span>
          <span class="metric-value" id="avg-disk">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞:</span>
          <span class="metric-value status-offline" id="critical-load">-</span>
        </div>
      </div>
    </div>

    <!-- Alerts Summary -->
    <div class="stat-card">
      <h3>–ê–ª–µ—Ä—Ç—ã</h3>
      <div class="stat-metrics">
        <div class="metric-row">
          <span class="metric-label">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:</span>
          <span class="metric-value" id="active-rules">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">–°—Ä–∞–±–æ—Ç–∞–≤—à–∏–µ —Å–µ–≥–æ–¥–Ω—è:</span>
          <span class="metric-value status-warning" id="today-alerts">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ:</span>
          <span class="metric-value status-offline" id="critical-alerts">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:</span>
          <span class="metric-value status-warning" id="warning-alerts">-</span>
        </div>
      </div>
    </div>

    <!-- System Health -->
    <div class="stat-card">
      <h3>–ó–¥–æ—Ä–æ–≤—å–µ —Å–∏—Å—Ç–µ–º—ã</h3>
      <div class="stat-metrics">
        <div class="metric-row">
          <span class="metric-label">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:</span>
          <span class="metric-value" id="uptime">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">–ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞:</span>
          <span class="metric-value" id="last-check">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–æ–∫:</span>
          <span class="metric-value" id="check-success-rate">-</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:</span>
          <span class="metric-value" id="avg-response-time">-</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="charts-section">
    <div class="chart-card">
      <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ CPU</h3>
      <canvas id="cpuDistributionChart" height="300"></canvas>
    </div>
    
    <div class="chart-card">
      <h3>–¢—Ä–µ–Ω–¥ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤</h3>
      <canvas id="availabilityTrendChart" height="300"></canvas>
    </div>
    
    <div class="chart-card">
      <h3>–¢–æ–ø —Å–µ—Ä–≤–µ—Ä–æ–≤ –ø–æ –Ω–∞–≥—Ä—É–∑–∫–µ</h3>
      <canvas id="topServersChart" height="300"></canvas>
    </div>
  </div>

  <script>
    let charts = {};

    async function refreshStats() {
      try {
        showLoadingOverlay('–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...');
        
        // Fetch server data
        const serversResponse = await fetch('/api/servers');
        const servers = await serversResponse.json();
        
        // Calculate statistics
        calculateSystemStats(servers);
        updateCharts(servers);
        
        hideLoadingOverlay();
      } catch (error) {
        console.error('Failed to refresh stats:', error);
        hideLoadingOverlay();
        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error');
      }
    }

    function calculateSystemStats(servers) {
      let totalServers = servers.length;
      let onlineServers = 0;
      let offlineServers = 0;
      let clusterServers = 0;
      let totalCpu = 0;
      let totalRam = 0;
      let totalDisk = 0;
      let cpuCount = 0;
      let ramCount = 0;
      let diskCount = 0;
      let criticalLoad = 0;

      servers.forEach(server => {
        const metric = server.latest_metric;
        
        if (metric) {
          if (metric.reachable) {
            onlineServers++;
          } else {
            offlineServers++;
          }
          
          if (metric.cpu_percent !== null && metric.cpu_percent !== undefined) {
            totalCpu += metric.cpu_percent;
            cpuCount++;
            if (metric.cpu_percent > 90) criticalLoad++;
          }
          
          if (metric.ram_percent !== null && metric.ram_percent !== undefined) {
            totalRam += metric.ram_percent;
            ramCount++;
          }
          
          if (metric.disk_percent !== null && metric.disk_percent !== undefined) {
            totalDisk += metric.disk_percent;
            diskCount++;
          }
        }
        
        if (server.is_cluster) {
          clusterServers++;
        }
      });

      // Update DOM elements
      document.getElementById('total-servers').textContent = totalServers;
      document.getElementById('online-servers').textContent = onlineServers;
      document.getElementById('offline-servers').textContent = offlineServers;
      document.getElementById('cluster-servers').textContent = clusterServers;
      
      document.getElementById('avg-cpu').textContent = cpuCount > 0 ? Math.round(totalCpu / cpuCount) + '%' : '-';
      document.getElementById('avg-ram').textContent = ramCount > 0 ? Math.round(totalRam / ramCount) + '%' : '-';
      document.getElementById('avg-disk').textContent = diskCount > 0 ? Math.round(totalDisk / diskCount) + '%' : '-';
      document.getElementById('critical-load').textContent = criticalLoad;
      
      // Mock data for other metrics
      document.getElementById('active-rules').textContent = '12';
      document.getElementById('today-alerts').textContent = '3';
      document.getElementById('critical-alerts').textContent = '1';
      document.getElementById('warning-alerts').textContent = '2';
      document.getElementById('uptime').textContent = '7–¥ 14—á 23–º';
      document.getElementById('last-check').textContent = new Date().toLocaleTimeString();
      document.getElementById('check-success-rate').textContent = '98.5%';
      document.getElementById('avg-response-time').textContent = '45–º—Å';
    }

    function updateCharts(servers) {
      // CPU Distribution Chart
      updateCpuDistributionChart(servers);
      
      // Availability Trend Chart
      updateAvailabilityTrendChart(servers);
      
      // Top Servers Chart
      updateTopServersChart(servers);
    }

    function updateCpuDistributionChart(servers) {
      const ctx = document.getElementById('cpuDistributionChart').getContext('2d');
      
      const cpuRanges = {
        '0-25%': 0,
        '25-50%': 0,
        '50-75%': 0,
        '75-90%': 0,
        '90-100%': 0
      };
      
      servers.forEach(server => {
        const cpu = server.latest_metric?.cpu_percent;
        if (cpu !== null && cpu !== undefined) {
          if (cpu <= 25) cpuRanges['0-25%']++;
          else if (cpu <= 50) cpuRanges['25-50%']++;
          else if (cpu <= 75) cpuRanges['50-75%']++;
          else if (cpu <= 90) cpuRanges['75-90%']++;
          else cpuRanges['90-100%']++;
        }
      });
      
      if (charts.cpuDistribution) {
        charts.cpuDistribution.destroy();
      }
      
      charts.cpuDistribution = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(cpuRanges),
          datasets: [{
            data: Object.values(cpuRanges),
            backgroundColor: [
              '#10b981',
              '#3b82f6',
              '#f59e0b',
              '#ef4444',
              '#dc2626'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    function updateAvailabilityTrendChart(servers) {
      const ctx = document.getElementById('availabilityTrendChart').getContext('2d');
      
      // Mock data for availability trend
      const labels = [];
      const onlineData = [];
      const offlineData = [];
      
      for (let i = 23; i >= 0; i--) {
        const time = new Date();
        time.setHours(time.getHours() - i);
        labels.push(time.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }));
        
        // Mock trend data
        const baseOnline = Math.floor(servers.length * 0.9);
        const variation = Math.floor(Math.random() * 3) - 1;
        onlineData.push(Math.max(0, baseOnline + variation));
        offlineData.push(servers.length - (baseOnline + variation));
      }
      
      if (charts.availabilityTrend) {
        charts.availabilityTrend.destroy();
      }
      
      charts.availabilityTrend = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: '–û–Ω–ª–∞–π–Ω',
            data: onlineData,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4
          }, {
            label: '–û—Ñ—Ñ–ª–∞–π–Ω',
            data: offlineData,
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239, 68, 68, 0.1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              stacked: true
            }
          }
        }
      });
    }

    function updateTopServersChart(servers) {
      const ctx = document.getElementById('topServersChart').getContext('2d');
      
      // Sort servers by CPU usage
      const sortedServers = servers
        .filter(s => s.latest_metric?.cpu_percent !== null)
        .sort((a, b) => (b.latest_metric?.cpu_percent || 0) - (a.latest_metric?.cpu_percent || 0))
        .slice(0, 10);
      
      const labels = sortedServers.map(s => s.hostname);
      const cpuData = sortedServers.map(s => s.latest_metric?.cpu_percent || 0);
      
      if (charts.topServers) {
        charts.topServers.destroy();
      }
      
      charts.topServers = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'CPU %',
            data: cpuData,
            backgroundColor: cpuData.map(cpu => 
              cpu > 90 ? '#ef4444' : 
              cpu > 75 ? '#f59e0b' : 
              '#10b981'
            )
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              max: 100
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', refreshStats);
  </script>
{% endblock %}
