{% extends "base.html" %}
{% block title %}–°–µ—Ä–≤–µ—Ä—ã ‚Ä¢ Server Check{% endblock %}
{% block head %}{% endblock %}
{% block content %}
  <div class="page-header">
    <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞–º–∏</h1>
    <div class="page-actions">
      {% if is_admin %}
      <a href="/servers/export.csv" class="btn btn-secondary">
        üìä –≠–∫—Å–ø–æ—Ä—Ç CSV
      </a>
      {% endif %}
    </div>
  </div>


  <!-- Enhanced Filters -->
  <div class="card filters-card">
    <div class="card-header">
      <h3>üîç –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫</h3>
      <div class="filter-actions">
        <button type="button" class="btn btn-sm btn-secondary" onclick="toggleAdvancedFilters()">
          <span id="advanced-toggle-icon">‚öôÔ∏è</span> <span id="advanced-toggle-text">–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ</span>
        </button>
        <button type="button" class="btn btn-sm btn-secondary" onclick="saveFilterPreset()">
          üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
        <button type="button" class="btn btn-sm btn-secondary" onclick="loadFilterPresets()">
          üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å
        </button>
      </div>
        </div>
    <div class="card-body">
      <form method="get" action="/servers" class="filters-form" id="filters-form">
        <!-- Basic Filters -->
        <div class="filter-section">
          <h4 class="filter-section-title">üîç –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</h4>
          <div class="filters-form-row">
        <div class="form-group">
              <label class="form-label">–ü–æ–∏—Å–∫</label>
              <div class="search-input-group">
                <input name="q" placeholder="–ü–æ–∏—Å–∫ –ø–æ hostname, IP, —Å–∏—Å—Ç–µ–º–µ..." value="{{ params.q }}" class="form-control search-input" />
                <button type="button" class="search-clear" onclick="clearSearch()">‚úï</button>
        </div>
        </div>
        <div class="form-group">
              <label class="form-label">–¢–µ–≥–∏</label>
              <input name="tag" placeholder="web,nginx,production" value="{{ params.tag }}" class="form-control" />
        </div>
        <div class="form-group">
              <label class="form-label">–°—Ä–µ–¥–∞</label>
          <select name="environment" class="form-control">
            <option value="">–í—Å–µ —Å—Ä–µ–¥—ã</option>
            <option value="test" {% if params.environment=='test' %}selected{% endif %}>üß™ Test</option>
            <option value="stage" {% if params.environment=='stage' %}selected{% endif %}>üöÄ Stage</option>
            <option value="prod" {% if params.environment=='prod' %}selected{% endif %}>üè≠ Prod</option>
          </select>
        </div>
        <div class="form-group">
              <label class="form-label">–°—Ç–∞—Ç—É—Å</label>
              <select name="reachable" class="form-control">
                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="yes" {% if params.reachable=='yes' %}selected{% endif %}>üü¢ –û–Ω–ª–∞–π–Ω</option>
                <option value="no" {% if params.reachable=='no' %}selected{% endif %}>üî¥ –û—Ñ—Ñ–ª–∞–π–Ω</option>
          </select>
        </div>
      </div>
        </div>

        <!-- Advanced Filters -->
        <div class="filter-section advanced-filters" id="advanced-filters" style="display: none;">
          <h4 class="filter-section-title">‚öôÔ∏è –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</h4>
          <div class="filters-form-row">
            <div class="form-group">
              <label class="form-label">–¢–∏–ø —Å–µ—Ä–≤–µ—Ä–∞</label>
              <select name="cluster" class="form-control">
                <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                <option value="yes" {% if params.cluster=='yes' %}selected{% endif %}>üîÑ –ö–ª–∞—Å—Ç–µ—Ä—ã</option>
                <option value="no" {% if params.cluster=='no' %}selected{% endif %}>üñ•Ô∏è –û–±—ã—á–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
              <input name="owner" placeholder="admin@company.com" value="{{ params.owner }}" class="form-control" />
            </div>
            <div class="form-group">
              <label class="form-label">–°–∏—Å—Ç–µ–º–∞</label>
              <select name="system" class="form-control">
                <option value="">–í—Å–µ —Å–∏—Å—Ç–µ–º—ã</option>
                <option value="Web Server" {% if params.system=='Web Server' %}selected{% endif %}>üåê Web Server</option>
                <option value="Database" {% if params.system=='Database' %}selected{% endif %}>üóÑÔ∏è Database</option>
                <option value="Application" {% if params.system=='Application' %}selected{% endif %}>‚öôÔ∏è Application</option>
                <option value="Monitoring" {% if params.system=='Monitoring' %}selected{% endif %}>üìä Monitoring</option>
                <option value="Backup" {% if params.system=='Backup' %}selected{% endif %}>üíæ Backup</option>
                <option value="Load Balancer" {% if params.system=='Load Balancer' %}selected{% endif %}>‚öñÔ∏è Load Balancer</option>
                <option value="Cache" {% if params.system=='Cache' %}selected{% endif %}>üöÄ Cache</option>
                <option value="Mail Server" {% if params.system=='Mail Server' %}selected{% endif %}>üìß Mail Server</option>
                <option value="File Server" {% if params.system=='File Server' %}selected{% endif %}>üìÅ File Server</option>
                <option value="DNS Server" {% if params.system=='DNS Server' %}selected{% endif %}>üåç DNS Server</option>
                <option value="Proxy Server" {% if params.system=='Proxy Server' %}selected{% endif %}>üîí Proxy Server</option>
                <option value="Other" {% if params.system=='Other' %}selected{% endif %}>‚ùì Other</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Sorting and Display -->
        <div class="filter-section">
          <h4 class="filter-section-title">üìä –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h4>
          <div class="filters-form-row">
            <div class="form-group">
              <label class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
              <select name="sort" class="form-control">
                <option value="">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
                <option value="hostname" {% if params.sort=='hostname' %}selected{% endif %}>üñ•Ô∏è Hostname</option>
                <option value="ip" {% if params.sort=='ip' %}selected{% endif %}>üåê IP –∞–¥—Ä–µ—Å</option>
                <option value="reachable" {% if params.sort=='reachable' %}selected{% endif %}>üì° –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å</option>
                <option value="cpu" {% if params.sort=='cpu' %}selected{% endif %}>‚ö° CPU</option>
                <option value="ram" {% if params.sort=='ram' %}selected{% endif %}>üíæ RAM</option>
                <option value="environment" {% if params.sort=='environment' %}selected{% endif %}>üè∑Ô∏è –°—Ä–µ–¥–∞</option>
                <option value="system" {% if params.sort=='system' %}selected{% endif %}>‚öôÔ∏è –°–∏—Å—Ç–µ–º–∞</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</label>
              <select name="per_page" class="form-control">
                <option value="25" {% if params.per_page=='25' %}selected{% endif %}>25 —Å–µ—Ä–≤–µ—Ä–æ–≤</option>
                <option value="50" {% if params.per_page=='50' %}selected{% endif %}>50 —Å–µ—Ä–≤–µ—Ä–æ–≤</option>
                <option value="100" {% if params.per_page=='100' %}selected{% endif %}>100 —Å–µ—Ä–≤–µ—Ä–æ–≤</option>
                <option value="all" {% if params.per_page=='all' %}selected{% endif %}>–í—Å–µ —Å–µ—Ä–≤–µ—Ä—ã</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</label>
              <div class="auto-refresh-group">
                <select name="auto_refresh" class="form-control">
                  <option value="">–í—ã–∫–ª—é—á–µ–Ω–æ</option>
                  <option value="30">30 —Å–µ–∫—É–Ω–¥</option>
                  <option value="60">1 –º–∏–Ω—É—Ç–∞</option>
                  <option value="300">5 –º–∏–Ω—É—Ç</option>
                </select>
                <span class="refresh-indicator" id="refresh-indicator" style="display: none;">üîÑ</span>
              </div>
            </div>
          </div>
        </div>

      </form>
    </div>
  </div>

  <!-- Filter Actions -->
  <div class="card filter-actions-card">
    <div class="card-body">
      <div class="filter-actions" style="padding: 20px;">
        <button type="submit" form="filters-form" class="btn btn-primary" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: 8px; background: #007bff; color: white; border: none; cursor: pointer; transition: all 0.3s ease; font-weight: 500; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">
          <span class="btn-icon">üîç</span>
          <span class="btn-text">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</span>
        </button>
        <button type="button" class="btn btn-secondary" onclick="resetFilters()">
          <span class="btn-icon">üîÑ</span>
          <span class="btn-text">–°–±—Ä–æ—Å–∏—Ç—å</span>
        </button>
        <button type="button" class="btn btn-secondary" onclick="exportFilteredResults()">
          <span class="btn-icon">üìä</span>
          <span class="btn-text">–≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</span>
        </button>
      </div>
    </div>
  </div>

  {% if is_admin %}
  <!-- Import/Export Actions -->
  <div class="card import-export-card">
    <div class="card-header">
      <h3>üìÅ –ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤</h3>
    </div>
    <div class="card-body">
      <form method="post" action="/servers/import.csv" enctype="multipart/form-data" class="import-form">
        <div class="form-group">
          <label class="form-label">üì§ –ò–º–ø–æ—Ä—Ç –∏–∑ CSV</label>
          <input type="file" name="file" accept=".csv" class="form-control" />
          <small class="form-text">–í—ã–±–µ—Ä–∏—Ç–µ CSV —Ñ–∞–π–ª –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤</small>
        </div>
        <button type="submit" class="btn btn-primary">üì• –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
  </form>
      <div class="export-section">
        <a href="/servers/export.csv" class="btn btn-secondary">üì§ –≠–∫—Å–ø–æ—Ä—Ç CSV</a>
      </div>
    </div>
  </div>

  <!-- Add Server Form -->
  <div class="card add-server-card">
    <div class="card-header">
      <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä</h3>
      <button type="button" class="btn btn-sm btn-secondary" onclick="toggleAddServerForm()">
        <span id="toggle-icon">üìù</span> <span id="toggle-text">–ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É</span>
      </button>
    </div>
    <div class="card-body" id="add-server-form" style="display: none;">
      <form method="post" action="/servers" class="add-server-form">
        <!-- Basic Information -->
        <div class="form-section">
          <h4 class="section-title">üìã –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
          <div class="filters-form-row">
            <div class="form-group">
              <label class="form-label">üñ•Ô∏è Hostname *</label>
              <input name="hostname" placeholder="server01.example.com" required class="form-control" />
              <small class="form-text">–£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Å–µ—Ä–≤–µ—Ä–∞</small>
            </div>
            <div class="form-group">
              <label class="form-label">üåê IP –∞–¥—Ä–µ—Å *</label>
              <input name="ip_address" placeholder="192.168.1.100" required class="form-control" />
              <small class="form-text">IP –∞–¥—Ä–µ—Å —Å–µ—Ä–≤–µ—Ä–∞</small>
            </div>
          </div>
          <div class="filters-form-row">
            <div class="form-group">
              <label class="form-label">‚öôÔ∏è –°–∏—Å—Ç–µ–º–∞</label>
              <input name="system_name" placeholder="Web Server" class="form-control" />
              <small class="form-text">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –∏–ª–∏ —Å–µ—Ä–≤–∏—Å–∞</small>
            </div>
            <div class="form-group">
              <label class="form-label">üë§ –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
              <input name="owner" placeholder="admin@company.com" class="form-control" />
              <small class="form-text">–ö–æ–Ω—Ç–∞–∫—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ</small>
            </div>
          </div>
          <div class="filters-form-row">
            <div class="form-group">
              <label class="form-label">üè∑Ô∏è –°—Ä–µ–¥–∞ *</label>
              <select name="environment" required class="form-control">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–µ–¥—É</option>
                <option value="prod">üè≠ Production</option>
                <option value="stage">üöÄ Staging</option>
                <option value="test">üß™ Testing</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">üè∑Ô∏è –¢–µ–≥–∏</label>
              <input name="tags" placeholder="web,nginx,production" class="form-control" />
              <small class="form-text">–¢–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</small>
            </div>
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" name="is_cluster" value="true" />
              <span class="checkbox-text">üîÑ –ö–ª–∞—Å—Ç–µ—Ä</span>
            </label>
            <small class="form-text">–û—Ç–º–µ—Ç—å—Ç–µ, –µ—Å–ª–∏ —ç—Ç–æ –∫–ª–∞—Å—Ç–µ—Ä —Å–µ—Ä–≤–µ—Ä–æ–≤</small>
          </div>
        </div>

        <!-- SSH Configuration -->
        <div class="form-section">
          <h4 class="section-title">üîê SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</h4>
          <div class="filters-form-row">
            <div class="form-group">
              <label class="form-label">üåê SSH Host</label>
              <input name="ssh_host" placeholder="192.168.1.100" class="form-control" />
              <small class="form-text">IP –∏–ª–∏ hostname –¥–ª—è SSH (–µ—Å–ª–∏ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ)</small>
            </div>
            <div class="form-group">
              <label class="form-label">üîå SSH Port</label>
              <input name="ssh_port" placeholder="22" value="22" class="form-control" />
            </div>
          </div>
          <div class="filters-form-row">
            <div class="form-group">
              <label class="form-label">üë§ SSH Username</label>
              <input name="ssh_username" placeholder="root" class="form-control" />
            </div>
            <div class="form-group">
              <label class="form-label">üîë SSH Password</label>
              <input name="ssh_password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="form-control" />
              <small class="form-text">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SSH –∫–ª—é—á–∏</small>
            </div>
          </div>
        </div>

        <!-- SNMP Configuration -->
        <div class="form-section">
          <h4 class="section-title">üìä SNMP –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</h4>
          <div class="filters-form-row">
            <div class="form-group">
              <label class="form-label">üì° SNMP Version</label>
              <select name="snmp_version" class="form-control">
                <option value="">–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SNMP</option>
                <option value="v2c">v2c</option>
                <option value="v3">v3</option>
      </select>
            </div>
            <div class="form-group">
              <label class="form-label">üîë SNMP Community</label>
              <input name="snmp_community" placeholder="public" class="form-control" />
              <small class="form-text">Community string –¥–ª—è SNMP v2c</small>
            </div>
          </div>
        </div>

        <!-- Monitoring Configuration -->
        <div class="form-section">
          <h4 class="section-title">üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ –ø–æ—Ä—Ç–æ–≤</h4>
          <div class="filters-form-row">
            <div class="form-group">
              <label class="form-label">‚öôÔ∏è –°–µ—Ä–≤–∏—Å—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</label>
              <input name="services_to_monitor" placeholder='["nginx", "mysql", "redis"]' class="form-control" />
              <small class="form-text">JSON –º–∞—Å—Å–∏–≤ –Ω–∞–∑–≤–∞–Ω–∏–π —Å–µ—Ä–≤–∏—Å–æ–≤ (systemctl)</small>
            </div>
            <div class="form-group">
              <label class="form-label">üîå –ü–æ—Ä—Ç—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞</label>
              <input name="ports_to_monitor" placeholder='["80", "443", "3306"]' class="form-control" />
              <small class="form-text">JSON –º–∞—Å—Å–∏–≤ –Ω–æ–º–µ—Ä–æ–≤ –ø–æ—Ä—Ç–æ–≤</small>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="submit" class="btn btn-primary btn-lg">
            <span class="btn-icon">‚ûï</span>
            <span class="btn-text">–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</span>
          </button>
          <button type="button" class="btn btn-secondary" onclick="resetAddServerForm()">
            <span class="btn-icon">üîÑ</span>
            <span class="btn-text">–°–±—Ä–æ—Å–∏—Ç—å</span>
          </button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- Servers Table -->
  <div class="card servers-table-card">
    <div class="card-header">
      <h3>üñ•Ô∏è –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤</h3>
      <div class="table-actions">
        <span class="servers-count">{{ servers|length }} —Å–µ—Ä–≤–µ—Ä–æ–≤</span>
        <div class="bulk-actions" id="bulk-actions" style="display: none;">
          <span class="bulk-count">–í—ã–±—Ä–∞–Ω–æ: <span id="selected-count">0</span></span>
          <button class="btn btn-sm btn-secondary" onclick="bulkEdit()">
            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
          </button>
          <button class="btn btn-sm btn-warning" onclick="bulkTag()">
            üè∑Ô∏è –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥–∏
          </button>
          <button class="btn btn-sm btn-error" onclick="bulkDelete()">
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <!-- Table View -->
      <div id="table-view" class="table-view">
  <div class="table-container">
          <table class="table servers-table">
      <thead>
        <tr>
                <th class="select-all-column">
                  <label class="checkbox-label">
                    <input type="checkbox" id="select-all" onchange="toggleSelectAll()" />
                    <span class="checkbox-text">–í—Å–µ</span>
                  </label>
                </th>
                <th class="sortable" data-sort="hostname">
                  <span class="sort-icon">üñ•Ô∏è</span> –°–µ—Ä–≤–µ—Ä
                </th>
                <th class="sortable" data-sort="reachable">
                  <span class="sort-icon">üì°</span> –°—Ç–∞—Ç—É—Å
                </th>
                <th class="sortable" data-sort="cpu">
                  <span class="sort-icon">‚ö°</span> CPU
                </th>
                <th class="sortable" data-sort="ram">
                  <span class="sort-icon">üíæ</span> RAM
                </th>
                <th>
                  <span class="sort-icon">üè∑Ô∏è</span> –°—Ä–µ–¥–∞
                </th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody>
        {% for s in servers %}
              {% set m = latest_map.get(s.id) %}
              <tr class="server-row" data-server-id="{{ s.id }}">
                <td class="select-column">
                  <label class="checkbox-label">
                    <input type="checkbox" class="server-checkbox" value="{{ s.id }}" onchange="updateBulkActions()" />
                  </label>
                </td>
                <td>
                  <div class="server-info">
            <div class="server-name">
              <strong>{{ s.hostname }}</strong>
              {% if s.is_cluster %}
                        <span class="cluster-badge">üîÑ</span>
              {% endif %}
            </div>
                    <div class="server-details">
                      <code class="ip-address">{{ s.ip_address }}</code>
                      {% if s.system_name %}
                        <span class="system-name">{{ s.system_name }}</span>
            {% endif %}
                    </div>
            {% if s.tags %}
              <div class="tags">
                        {% for tag in s.tags.split(',')[:3] %}
                  <span class="tag">{{ tag.strip() }}</span>
                {% endfor %}
                        {% if s.tags.split(',')|length > 3 %}
                          <span class="tag-more">+{{ s.tags.split(',')|length - 3 }}</span>
                        {% endif %}
              </div>
            {% endif %}
                  </div>
          </td>
          <td>
            {% if m and m.reachable %}
                    <span class="status-indicator online"></span>
                    <span class="status-text">–û–Ω–ª–∞–π–Ω</span>
            {% elif m and m.reachable == False %}
                    <span class="status-indicator offline"></span>
                    <span class="status-text">–û—Ñ—Ñ–ª–∞–π–Ω</span>
            {% else %}
                    <span class="status-indicator unknown"></span>
                    <span class="status-text">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>
            {% endif %}
          </td>
          <td>
            {% if m and m.cpu_percent is not none %}
                    <div class="metric-display">
              <span class="metric-badge {{ 'metric-critical' if m.cpu_percent > 90 else 'metric-warning' if m.cpu_percent > 75 else 'metric-ok' }}">
                {{ "%.1f"|format(m.cpu_percent) }}%
              </span>
                      <div class="metric-bar">
                        <div class="metric-fill metric-fill-cpu" data-width="{{ m.cpu_percent }}" data-value="{{ m.cpu_percent }}"></div>
                      </div>
                    </div>
            {% else %}
                    <span class="metric-unknown">‚Äî</span>
            {% endif %}
          </td>
          <td>
            {% if m and m.ram_percent is not none %}
                    <div class="metric-display">
              <span class="metric-badge {{ 'metric-critical' if m.ram_percent > 90 else 'metric-warning' if m.ram_percent > 75 else 'metric-ok' }}">
                {{ "%.1f"|format(m.ram_percent) }}%
              </span>
                      <div class="metric-bar">
                        <div class="metric-fill metric-fill-ram" data-width="{{ m.ram_percent }}" data-value="{{ m.ram_percent }}"></div>
                      </div>
                    </div>
                  {% else %}
                    <span class="metric-unknown">‚Äî</span>
                  {% endif %}
                </td>
                <td>
                  {% if s.environment == 'test' %}
                    <span class="environment-badge environment-test">üß™</span>
                  {% elif s.environment == 'stage' %}
                    <span class="environment-badge environment-stage">üöÄ</span>
                  {% elif s.environment == 'prod' %}
                    <span class="environment-badge environment-prod">üè≠</span>
            {% else %}
                    <span class="environment-badge environment-unknown">‚ùì</span>
            {% endif %}
          </td>
          <td>
            <div class="action-buttons">
                    <a href="/servers/{{ s.id }}" class="btn btn-sm btn-primary" title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ">
                      <span class="btn-icon">üëÅ</span>
                    </a>
              {% if is_admin %}
                      <a href="/servers/{{ s.id }}/edit" class="btn btn-sm btn-secondary" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                        <span class="btn-icon">‚úèÔ∏è</span>
                      </a>
                      <button type="button" class="btn btn-sm btn-error" data-server-id="{{ s.id }}" data-server-name="{{ s.hostname }}" onclick="deleteServerFromButton(this)" title="–£–¥–∞–ª–∏—Ç—å">
                        <span class="btn-icon">üóë</span>
                      </button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
        </div>
      </div>

    </div>
  </div>

  <!-- Pagination -->
  {% if pagination %}
  <div class="pagination">
    {% if pagination.has_prev %}
      <a href="?{{ request.query_params|urlencode }}&page={{ pagination.prev_num }}" class="btn btn-secondary">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
    {% endif %}
    
    {% for page_num in pagination.iter_pages() %}
      {% if page_num %}
        {% if page_num != pagination.page %}
          <a href="?{{ request.query_params|urlencode }}&page={{ page_num }}" class="btn btn-secondary">{{ page_num }}</a>
        {% else %}
          <span class="btn btn-primary current">{{ page_num }}</span>
        {% endif %}
      {% else %}
        <span class="btn btn-secondary disabled">...</span>
      {% endif %}
    {% endfor %}
    
    {% if pagination.has_next %}
      <a href="?{{ request.query_params|urlencode }}&page={{ pagination.next_num }}" class="btn btn-secondary">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</a>
    {% endif %}
  </div>
  {% endif %}

  <script>
    // Toggle Add Server Form
    function toggleAddServerForm() {
      const form = document.getElementById('add-server-form');
      const toggleIcon = document.getElementById('toggle-icon');
      const toggleText = document.getElementById('toggle-text');
      
      if (form.style.display === 'none') {
        form.style.display = 'block';
        toggleIcon.textContent = 'üìù';
        toggleText.textContent = '–°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É';
        form.scrollIntoView({ behavior: 'smooth' });
      } else {
        form.style.display = 'none';
        toggleIcon.textContent = 'üìù';
        toggleText.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É';
      }
    }

    // Reset Add Server Form
    function resetAddServerForm() {
      const form = document.querySelector('.add-server-form');
      form.reset();
      showNotification('–§–æ—Ä–º–∞ —Å–±—Ä–æ—à–µ–Ω–∞', 'info', 2000);
    }


    // Delete Server with Confirmation
    function deleteServer(serverId, hostname) {
      if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä "${hostname}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
        // Create form and submit
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/servers/${serverId}/delete`;
        document.body.appendChild(form);
        form.submit();
      }
    }

    // Delete Server from Button
    function deleteServerFromButton(button) {
      const serverId = button.getAttribute('data-server-id');
      const hostname = button.getAttribute('data-server-name');
      deleteServer(serverId, hostname);
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      
      // Initialize metric bars
      initializeMetricBars();
      
      // Add loading states to forms
      const forms = document.querySelectorAll('form');
      forms.forEach(form => {
        form.addEventListener('submit', function() {
          const submitBtn = form.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span> –û–±—Ä–∞–±–æ—Ç–∫–∞...';
          }
        });
      });

      // Add hover effects to server rows
      const serverRows = document.querySelectorAll('.server-row');
      serverRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
          this.style.backgroundColor = 'var(--bg-tertiary)';
        });
        row.addEventListener('mouseleave', function() {
          this.style.backgroundColor = '';
        });
      });
    });

    // Enhanced form validation
    function validateServerForm() {
      const form = document.querySelector('.add-server-form');
      if (!form) {
        console.error('Add server form not found');
        return false;
      }
      
      const hostname = form.querySelector('input[name="hostname"]');
      const ipAddress = form.querySelector('input[name="ip_address"]');
      const environment = form.querySelector('select[name="environment"]');
      
      if (!hostname || !ipAddress || !environment) {
        console.error('Required form fields not found');
        return false;
      }
      
      let isValid = true;
      
      // Validate hostname
      if (!hostname.value.trim()) {
        showFieldError(hostname, 'Hostname –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
        isValid = false;
      } else {
        clearFieldError(hostname);
      }
      
      // Validate IP address
      const ipRegex = /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
      if (!ipAddress.value.trim()) {
        showFieldError(ipAddress, 'IP –∞–¥—Ä–µ—Å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
        isValid = false;
      } else if (!ipRegex.test(ipAddress.value)) {
        showFieldError(ipAddress, '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç IP –∞–¥—Ä–µ—Å–∞');
        isValid = false;
      } else {
        clearFieldError(ipAddress);
      }
      
      // Validate environment
      if (!environment.value) {
        showFieldError(environment, '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–µ–¥—É');
        isValid = false;
      } else {
        clearFieldError(environment);
      }
      
      return isValid;
    }

    function showFieldError(field, message) {
      clearFieldError(field);
      field.classList.add('error');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'field-error';
      errorDiv.textContent = message;
      field.parentNode.appendChild(errorDiv);
    }

    function clearFieldError(field) {
      field.classList.remove('error');
      const errorDiv = field.parentNode.querySelector('.field-error');
      if (errorDiv) {
        errorDiv.remove();
      }
    }

    // Initialize metric bars with animation
    function initializeMetricBars() {
      const metricFills = document.querySelectorAll('.metric-fill[data-value]');
      
      metricFills.forEach(fill => {
        const value = parseFloat(fill.getAttribute('data-value'));
        const width = fill.getAttribute('data-width');
        
        if (value > 90) {
          fill.classList.add('critical');
        } else if (value > 75) {
          fill.classList.add('warning');
        } else {
          fill.classList.add('ok');
        }
        
        // Animate the bar
        setTimeout(() => {
          fill.style.width = width + '%';
        }, 100);
      });
    }

    // Enhanced Filter Functions
    function toggleAdvancedFilters() {
      const filters = document.getElementById('advanced-filters');
      const toggleIcon = document.getElementById('advanced-toggle-icon');
      const toggleText = document.getElementById('advanced-toggle-text');
      
      if (filters.style.display === 'none') {
        filters.style.display = 'block';
        toggleIcon.textContent = '‚öôÔ∏è';
        toggleText.textContent = '–°–∫—Ä—ã—Ç—å';
      } else {
        filters.style.display = 'none';
        toggleIcon.textContent = '‚öôÔ∏è';
        toggleText.textContent = '–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ';
      }
    }

    function clearSearch() {
      document.querySelector('.search-input').value = '';
      document.querySelector('.search-input').focus();
    }

    function resetFilters() {
      document.getElementById('filters-form').reset();
      showNotification('–§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã', 'info', 2000);
    }

    function exportFilteredResults() {
      const form = document.getElementById('filters-form');
      const action = form.action;
      form.action = '/servers/export.csv';
      form.submit();
      form.action = action;
    }

    // Bulk Operations
    function toggleSelectAll() {
      const selectAll = document.getElementById('select-all');
      const checkboxes = document.querySelectorAll('.server-checkbox');
      
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
      });
      
      updateBulkActions();
    }

    function updateBulkActions() {
      const checkboxes = document.querySelectorAll('.server-checkbox:checked');
      const bulkActions = document.getElementById('bulk-actions');
      const selectedCount = document.getElementById('selected-count');
      
      selectedCount.textContent = checkboxes.length;
      
      if (checkboxes.length > 0) {
        bulkActions.style.display = 'flex';
      } else {
        bulkActions.style.display = 'none';
      }
    }

    function bulkEdit() {
      const selected = getSelectedServers();
      if (selected.length === 0) return;
      
      showNotification(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ${selected.length} —Å–µ—Ä–≤–µ—Ä–æ–≤`, 'info');
      // TODO: Implement bulk edit modal
    }

    function bulkTag() {
      const selected = getSelectedServers();
      if (selected.length === 0) return;
      
      const tags = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é:');
      if (tags) {
        showNotification(`–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–æ–≤ –∫ ${selected.length} —Å–µ—Ä–≤–µ—Ä–∞–º`, 'info');
        // TODO: Implement bulk tag update
      }
    }

    function bulkDelete() {
      const selected = getSelectedServers();
      if (selected.length === 0) return;
      
      if (confirm(`–£–¥–∞–ª–∏—Ç—å ${selected.length} —Å–µ—Ä–≤–µ—Ä–æ–≤? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
        showNotification(`–£–¥–∞–ª–µ–Ω–∏–µ ${selected.length} —Å–µ—Ä–≤–µ—Ä–æ–≤`, 'warning');
        // TODO: Implement bulk delete
      }
    }

    function getSelectedServers() {
      const checkboxes = document.querySelectorAll('.server-checkbox:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }


    // Keyboard Shortcuts
    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey) {
          switch(e.key) {
            case 'n':
              e.preventDefault();
              toggleAddServerForm();
              break;
            case 'f':
              e.preventDefault();
              document.querySelector('.search-input').focus();
              break;
            case 'a':
              e.preventDefault();
              if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                toggleSelectAll();
              }
              break;
          }
        }
      });
    }

    // Range Input Handlers
    function setupRangeInputs() {
      const rangeInputs = document.querySelectorAll('.range-input');
      rangeInputs.forEach(input => {
        input.addEventListener('input', function() {
          const valueSpan = this.parentNode.querySelector('.range-value');
          valueSpan.textContent = this.value + '%';
        });
      });
    }

    // Auto-refresh functionality
    function setupAutoRefresh() {
      const autoRefreshSelect = document.querySelector('select[name="auto_refresh"]');
      if (autoRefreshSelect) {
        autoRefreshSelect.addEventListener('change', function() {
          const interval = parseInt(this.value);
          if (interval > 0) {
            startAutoRefresh(interval);
          } else {
            stopAutoRefresh();
          }
        });
      }
    }

    let autoRefreshInterval;

    function startAutoRefresh(seconds) {
      stopAutoRefresh();
      const indicator = document.getElementById('refresh-indicator');
      indicator.style.display = 'inline';
      
      autoRefreshInterval = setInterval(() => {
        location.reload();
      }, seconds * 1000);
    }

    function stopAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
      }
      document.getElementById('refresh-indicator').style.display = 'none';
    }

    // Add form validation on submit
    document.addEventListener('DOMContentLoaded', function() {
      const addServerForm = document.querySelector('.add-server-form');
      if (addServerForm) {
        console.log('Add server form found, adding submit listener');
        addServerForm.addEventListener('submit', function(e) {
          console.log('Form submit event triggered');
          if (!validateServerForm()) {
            console.log('Form validation failed, preventing submit');
            e.preventDefault();
            showNotification('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ', 'error');
          } else {
            console.log('Form validation passed, allowing submit');
          }
        });
      } else {
        console.error('Add server form not found');
      }
      
      // Initialize new features
      setupKeyboardShortcuts();
      setupRangeInputs();
      setupAutoRefresh();
    });
  </script>
{% endblock %}


