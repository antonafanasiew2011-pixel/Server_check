{% extends "base.html" %}
{% block title %}–°–µ—Ä–≤–µ—Ä—ã ‚Ä¢ Server Check{% endblock %}
{% block head %}{% endblock %}
{% block content %}
  <div class="page-header">
    <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞–º–∏</h1>
    <div class="page-actions">
      {% if is_admin %}
      <a href="/servers/export.csv" class="btn btn-secondary">
        üìä –≠–∫—Å–ø–æ—Ä—Ç CSV
      </a>
      {% endif %}
    </div>
  </div>

  <div class="filters-card">
    <form method="get" action="/servers" class="filters-form">
      <div class="form-row">
        <div class="form-group">
          <input name="q" placeholder="–ü–æ–∏—Å–∫ –ø–æ hostname –∏–ª–∏ IP..." value="{{ params.q }}" class="form-control" />
        </div>
        <div class="form-group">
          <input name="tag" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ —Ç–µ–≥–∞–º..." value="{{ params.tag }}" class="form-control" />
        </div>
        <div class="form-group">
          <select name="cluster" class="form-control">
            <option value="">–í—Å–µ –∫–ª–∞—Å—Ç–µ—Ä—ã</option>
            <option value="yes" {% if params.cluster=='yes' %}selected{% endif %}>–ö–ª–∞—Å—Ç–µ—Ä—ã</option>
            <option value="no" {% if params.cluster=='no' %}selected{% endif %}>–û–±—ã—á–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã</option>
          </select>
        </div>
        <div class="form-group">
          <select name="reachable" class="form-control">
            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
            <option value="yes" {% if params.reachable=='yes' %}selected{% endif %}>–û–Ω–ª–∞–π–Ω</option>
            <option value="no" {% if params.reachable=='no' %}selected{% endif %}>–û—Ñ—Ñ–ª–∞–π–Ω</option>
          </select>
        </div>
        <div class="form-group">
          <select name="environment" class="form-control">
            <option value="">–í—Å–µ —Å—Ä–µ–¥—ã</option>
            <option value="test" {% if params.environment=='test' %}selected{% endif %}>üß™ Test</option>
            <option value="stage" {% if params.environment=='stage' %}selected{% endif %}>üöÄ Stage</option>
            <option value="prod" {% if params.environment=='prod' %}selected{% endif %}>üè≠ Prod</option>
          </select>
        </div>
        <div class="form-group">
          <select name="sort" class="form-control">
            <option value="">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</option>
            <option value="hostname" {% if params.sort=='hostname' %}selected{% endif %}>Hostname</option>
            <option value="ip" {% if params.sort=='ip' %}selected{% endif %}>IP –∞–¥—Ä–µ—Å</option>
            <option value="reachable" {% if params.sort=='reachable' %}selected{% endif %}>–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å</option>
            <option value="cpu" {% if params.sort=='cpu' %}selected{% endif %}>CPU</option>
            <option value="ram" {% if params.sort=='ram' %}selected{% endif %}>RAM</option>
          </select>
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">üîç –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>
        <a href="/servers" class="btn btn-secondary">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</a>
      </div>
    </form>
  </div>

  {% if is_admin %}
  <form method="post" action="/servers/import.csv" enctype="multipart/form-data" style="margin-bottom: 8px; margin-top:8px; display:flex; gap:8px; align-items:center;">
    <input type="file" name="file" accept=".csv" />
    <button type="submit">–ò–º–ø–æ—Ä—Ç CSV</button>
    <a href="/servers/export.csv">–≠–∫—Å–ø–æ—Ä—Ç CSV</a>
  </form>
  <form method="post" action="/servers" style="margin-bottom: 10px;">
    <div class="row">
      <input name="hostname" placeholder="Hostname" required />
      <input name="ip_address" placeholder="IP" required />
      <input name="system_name" placeholder="–°–∏—Å—Ç–µ–º–∞" />
      <input name="owner" placeholder="–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π" />
      <select name="environment" required>
        <option value="prod">üè≠ Prod</option>
        <option value="stage">üöÄ Stage</option>
        <option value="test">üß™ Test</option>
      </select>
      <input name="tags" placeholder="–¢–µ–≥–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)" />
      <input name="ssh_host" placeholder="SSH host (–æ–ø—Ü.)" />
      <input name="ssh_port" placeholder="port" value="22" style="width:80px;" />
      <input name="ssh_username" placeholder="SSH user" />
      <input name="ssh_password" placeholder="SSH pass" />
      <input name="snmp_version" placeholder="SNMP ver (v2c)" />
      <input name="snmp_community" placeholder="SNMP community" />
      <label><input type="checkbox" name="is_cluster" value="true"/> –ö–ª–∞—Å—Ç–µ—Ä</label>
      <button style="margin-right: 0px; margin-left: 0px; margin-top: 10px;" type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </form>
  {% endif %}

  <div class="table-container">
    <table class="servers-table">
      <thead>
        <tr>
          <th class="sortable" data-sort="hostname">Hostname</th>
          <th class="sortable" data-sort="ip">IP –∞–¥—Ä–µ—Å</th>
          <th>–°–∏—Å—Ç–µ–º–∞</th>
          <th>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
          <th>–ö–ª–∞—Å—Ç–µ—Ä</th>
          <th>–°—Ä–µ–¥–∞</th>
          <th>–¢–µ–≥–∏</th>
          <th class="sortable" data-sort="reachable">–°—Ç–∞—Ç—É—Å</th>
          <th class="sortable" data-sort="cpu">CPU</th>
          <th class="sortable" data-sort="ram">RAM</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody>
        {% for s in servers %}
        <tr>
          <td>
            <div class="server-name">
              <strong>{{ s.hostname }}</strong>
              {% if s.is_cluster %}
                <span class="cluster-badge">–ö–ª–∞—Å—Ç–µ—Ä</span>
              {% endif %}
            </div>
          </td>
          <td>
            <code>{{ s.ip_address }}</code>
          </td>
          <td>{{ s.system_name or '‚Äî' }}</td>
          <td>{{ s.owner or '‚Äî' }}</td>
          <td>
            {% if s.is_cluster %}
              <span class="status-badge status-online">–î–∞</span>
            {% else %}
              <span class="status-badge status-unknown">–ù–µ—Ç</span>
            {% endif %}
          </td>
          <td>
            {% if s.environment == 'test' %}
              <span class="environment-badge environment-test">üß™ Test</span>
            {% elif s.environment == 'stage' %}
              <span class="environment-badge environment-stage">üöÄ Stage</span>
            {% elif s.environment == 'prod' %}
              <span class="environment-badge environment-prod">üè≠ Prod</span>
            {% else %}
              <span class="environment-badge environment-unknown">‚ùì {{ s.environment or 'Unknown' }}</span>
            {% endif %}
          </td>
          <td>
            {% if s.tags %}
              <div class="tags">
                {% for tag in s.tags.split(',') %}
                  <span class="tag">{{ tag.strip() }}</span>
                {% endfor %}
              </div>
            {% else %}
              ‚Äî
            {% endif %}
          </td>
          {% set m = latest_map.get(s.id) %}
          <td>
            {% if m and m.reachable %}
              <span class="status-badge status-online">üü¢ –û–Ω–ª–∞–π–Ω</span>
            {% elif m and m.reachable == False %}
              <span class="status-badge status-offline">üî¥ –û—Ñ—Ñ–ª–∞–π–Ω</span>
            {% else %}
              <span class="status-badge status-unknown">‚ö™ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>
            {% endif %}
          </td>
          <td>
            {% if m and m.cpu_percent is not none %}
              <span class="metric-badge {{ 'metric-critical' if m.cpu_percent > 90 else 'metric-warning' if m.cpu_percent > 75 else 'metric-ok' }}">
                {{ "%.1f"|format(m.cpu_percent) }}%
              </span>
            {% else %}
              ‚Äî
            {% endif %}
          </td>
          <td>
            {% if m and m.ram_percent is not none %}
              <span class="metric-badge {{ 'metric-critical' if m.ram_percent > 90 else 'metric-warning' if m.ram_percent > 75 else 'metric-ok' }}">
                {{ "%.1f"|format(m.ram_percent) }}%
              </span>
            {% else %}
              ‚Äî
            {% endif %}
          </td>
          <td>
            <div class="action-buttons">
              <a href="/servers/{{ s.id }}" class="btn btn-sm btn-primary">üëÅ –ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
              {% if is_admin %}
                <form method="post" action="/servers/{{ s.id }}/delete" style="display:inline;">
                  <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä {{ s.hostname }}?')">üóë</button>
                </form>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  {% if pagination %}
  <div class="pagination">
    {% if pagination.has_prev %}
      <a href="?{{ request.query_params|urlencode }}&page={{ pagination.prev_num }}" class="btn btn-secondary">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
    {% endif %}
    
    {% for page_num in pagination.iter_pages() %}
      {% if page_num %}
        {% if page_num != pagination.page %}
          <a href="?{{ request.query_params|urlencode }}&page={{ page_num }}" class="btn btn-secondary">{{ page_num }}</a>
        {% else %}
          <span class="btn btn-primary current">{{ page_num }}</span>
        {% endif %}
      {% else %}
        <span class="btn btn-secondary disabled">...</span>
      {% endif %}
    {% endfor %}
    
    {% if pagination.has_next %}
      <a href="?{{ request.query_params|urlencode }}&page={{ pagination.next_num }}" class="btn btn-secondary">–°–ª–µ–¥—É—é—â–∞—è ‚Üí</a>
    {% endif %}
  </div>
  {% endif %}
</body>
{% endblock %}


