{% extends "base.html" %}
{% block title %}{{ server.hostname }} ‚Ä¢ Server Check{% endblock %}
{% block head %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}
{% block content %}
  <div class="page-header">
    <div>
      <h1>{{ server.hostname }}</h1>
      <div class="server-meta">
        <span class="meta-item">IP: <code>{{ server.ip_address }}</code></span>
        <span class="meta-item">–°–∏—Å—Ç–µ–º–∞: {{ server.system_name or '‚Äî' }}</span>
        <span class="meta-item">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: {{ server.owner or '‚Äî' }}</span>
        {% if server.tags %}
          <span class="meta-item">–¢–µ–≥–∏: 
            {% for tag in server.tags.split(',') %}
              <span class="tag">{{ tag.strip() }}</span>
            {% endfor %}
          </span>
        {% endif %}
        {% if server.is_cluster %}
          <span class="meta-item">
            <span class="cluster-badge">–ö–ª–∞—Å—Ç–µ—Ä</span>
          </span>
        {% endif %}
      </div>
    </div>
    <div class="page-actions">
      <a href="/servers/{{ server.id }}/edit" class="btn btn-primary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
      <a href="/servers" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
    </div>
  </div>

  <div class="controls-card">
    <div class="controls-row">
      <div class="form-group">
        <label class="form-label">–ü–µ—Ä–∏–æ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
        <select id="range" class="form-control">
          <option value="60">1 —á–∞—Å</option>
          <option value="180" selected>3 —á–∞—Å–∞</option>
          <option value="720">12 —á–∞—Å–æ–≤</option>
          <option value="1440">1 –¥–µ–Ω—å</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</label>
        <button id="autoRefresh" class="btn btn-secondary">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
      </div>
    </div>
  </div>

  <div class="metrics-grid">
    <div class="metric-card">
      <div class="metric-header">
        <h3>üñ•Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ (CPU)</h3>
        <p class="metric-description">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ —Å–µ—Ä–≤–µ—Ä–∞. –í—ã—Å–æ–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è (>80%) –º–æ–≥—É—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –ø–µ—Ä–µ–≥—Ä—É–∑–∫—É —Å–∏—Å—Ç–µ–º—ã.</p>
      </div>
      <div class="chart-container">
        <canvas id="cpu"></canvas>
      </div>
    </div>

    <div class="metric-card">
      <div class="metric-header">
        <h3>üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ (RAM)</h3>
        <p class="metric-description">–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç –∑–∞–Ω—è—Ç–æ–π –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É—Ä–æ–≤–µ–Ω—å (>90%) –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –∑–∞–º–µ–¥–ª–µ–Ω–∏—é —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã.</p>
      </div>
      <div class="chart-container">
        <canvas id="ram"></canvas>
      </div>
    </div>

    <div class="metric-card">
      <div class="metric-header">
        <h3>üíø –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞ (Disk)</h3>
        <p class="metric-description">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞. –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ 95%+ —Å–∏—Å—Ç–µ–º–∞ –º–æ–∂–µ—Ç –ø–µ—Ä–µ—Å—Ç–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.</p>
      </div>
      <div class="chart-container">
        <canvas id="disk"></canvas>
      </div>
    </div>

    <div class="metric-card">
      <div class="metric-header">
        <h3>üåê –°–µ—Ç–µ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å (Network)</h3>
        <p class="metric-description">–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–π —Å–µ—Ç–µ–≤–æ–π —Ç—Ä–∞—Ñ–∏–∫ –≤ –∫–∏–ª–æ–±–∏—Ç–∞—Ö –≤ —Å–µ–∫—É–Ω–¥—É. –ü–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–µ—Ç–µ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã.</p>
      </div>
      <div class="chart-container">
        <canvas id="net"></canvas>
      </div>
    </div>

    <div class="metric-card">
      <div class="metric-header">
        <h3>‚öôÔ∏è –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (Processes)</h3>
        <p class="metric-description">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –†–µ–∑–∫–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –º–æ–∂–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è–º–∏.</p>
      </div>
      <div class="chart-container">
        <canvas id="proc"></canvas>
      </div>
    </div>
  </div>

  <script>
    const sid = {{ server.id }};
    let charts = {};
    let autoRefreshInterval = null;
    let isAutoRefreshEnabled = true;
    
    // Validate server ID
    if (!sid || isNaN(sid)) {
      console.error('Invalid server ID:', sid);
      document.body.innerHTML = '<div class="error-message">–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π ID —Å–µ—Ä–≤–µ—Ä–∞</div>';
    }

    function makeChart(id, label, yMax, color = '#3b82f6') {
      const canvas = document.getElementById(id);
      if (!canvas) {
        console.error(`Canvas element with id '${id}' not found`);
        return;
      }
      
      if (typeof Chart === 'undefined') {
        console.error('Chart.js library not loaded');
        return;
      }
      
      const ctx = canvas.getContext('2d');
      charts[id] = new Chart(ctx, {
        type: 'line',
        data: { 
          labels: [], 
          datasets: [{ 
            label, 
            data: [], 
            borderColor: color, 
            backgroundColor: color + '20',
            tension: 0.4, 
            pointRadius: 0,
            borderWidth: 2,
            fill: true
          }] 
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false,
          scales: { 
            y: yMax ? { min: 0, max: yMax } : { beginAtZero: true },
            x: {
              display: true,
              grid: {
                color: 'rgba(0,0,0,0.1)'
              }
            }
          }, 
          plugins: { 
            legend: { display: false },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0,0,0,0.8)',
              titleColor: 'white',
              bodyColor: 'white',
              borderColor: color,
              borderWidth: 1
            }
          },
          interaction: {
            intersect: false,
            mode: 'index'
          }
        }
      });
    }

    function updateChart(id, labels, data) {
      if (charts[id]) {
        charts[id].data.labels = labels;
        charts[id].data.datasets[0].data = data;
        charts[id].update('none');
      }
    }

    async function load() {
      try {
        const rangeElement = document.getElementById('range');
        if (!rangeElement) {
          console.error('Range element not found');
          return;
        }
        
        const minutes = rangeElement.value;
        const res = await fetch(`/api/metrics/${sid}?minutes=${minutes}`);
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const hist = await res.json();
        
        if (!hist || hist.length === 0) {
          console.log('No metrics data available');
          return;
        }

        const labels = hist.map(h => {
          try {
            // Convert to Moscow timezone (UTC+3)
            const date = new Date(h.timestamp);
            const moscowTime = new Date(date.getTime() + (3 * 60 * 60 * 1000)); // Add 3 hours
            return moscowTime.toLocaleTimeString('ru-RU', { 
              hour: '2-digit', 
              minute: '2-digit',
              timeZone: 'Europe/Moscow'
            });
          } catch (e) {
            return 'Invalid time';
          }
        });

        updateChart('cpu', labels, hist.map(h => h.cpu_percent || 0));
        updateChart('ram', labels, hist.map(h => h.ram_percent || 0));
        updateChart('disk', labels, hist.map(h => h.disk_percent || 0));
        updateChart('net', labels, hist.map(h => h.network_in_kbps || 0));
        updateChart('proc', labels, hist.map(h => h.processes || 0));
      } catch (error) {
        console.error('Failed to load metrics:', error);
        // Show error message in UI
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç—Ä–∏–∫: ' + error.message;
        errorDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #ef4444; color: white; padding: 10px; border-radius: 5px; z-index: 1000;';
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 5000);
      }
    }

    function toggleAutoRefresh() {
      const button = document.getElementById('autoRefresh');
      if (!button) {
        console.error('Auto refresh button not found');
        return;
      }
      
      if (isAutoRefreshEnabled) {
        clearInterval(autoRefreshInterval);
        button.textContent = '‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫';
        button.className = 'btn btn-success';
        isAutoRefreshEnabled = false;
      } else {
        autoRefreshInterval = setInterval(load, 10000);
        button.textContent = '‚è∏Ô∏è –ü–∞—É–∑–∞';
        button.className = 'btn btn-secondary';
        isAutoRefreshEnabled = true;
      }
    }

    // Initialize charts with different colors
    try {
      makeChart('cpu', 'CPU %', 100, '#ef4444');
      makeChart('ram', 'RAM %', 100, '#f59e0b');
      makeChart('disk', 'Disk %', 100, '#10b981');
      makeChart('net', 'Network Kbps', null, '#3b82f6');
      makeChart('proc', 'Processes', null, '#8b5cf6');
    } catch (error) {
      console.error('Failed to initialize charts:', error);
    }

    // Load initial data
    load();

    // Event listeners
    const rangeElement = document.getElementById('range');
    const autoRefreshElement = document.getElementById('autoRefresh');
    
    if (rangeElement) {
      rangeElement.addEventListener('change', load);
    } else {
      console.error('Range element not found for event listener');
    }
    
    if (autoRefreshElement) {
      autoRefreshElement.addEventListener('click', toggleAutoRefresh);
    } else {
      console.error('Auto refresh element not found for event listener');
    }

    // Start auto-refresh
    autoRefreshInterval = setInterval(load, 10000);
  </script>
{% endblock %}


